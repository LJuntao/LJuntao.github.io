<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>脓毒症患者风险预测计算器</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1100px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }
        
        header {
            background: #3498db;
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
            background: white;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            min-height: 500px;
        }
        
        .input-section {
            flex: 1;
            min-width: 300px;
            padding: 25px;
            border-right: 1px solid #eee;
        }
        
        .result-section {
            flex: 1;
            min-width: 300px;
            padding: 25px;
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-bottom: 15px;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .example-btn {
            background: #2ecc71;
        }
        
        .example-btn:hover {
            background: #27ae60;
        }
        
        .result-box {
            flex: 1;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        .risk-low {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .risk-medium {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }
        
        .risk-high {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .probability {
            font-size: 42px;
            font-weight: 700;
            margin: 15px 0;
        }
        
        .risk-level {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .recommendation {
            font-size: 16px;
            line-height: 1.5;
        }
        
        .model-info {
            background: #f8f9fa;
            padding: 20px;
            border-top: 1px solid #eee;
        }
        
        .info-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .feature-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .feature-item {
            background: #e9ecef;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .tab-content {
            display: none;
            width: 100%;
        }
        
        .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .input-section {
                border-right: none;
                border-bottom: 1px solid #eee;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>脓毒症患者风险预测计算器</h1>
            <p class="subtitle">基于XGBoost机器学习模型 - 机械通气风险预测 | 死亡风险预测</p>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-tab="ventilation">机械通气风险预测</div>
            <div class="tab" data-tab="mortality">死亡风险预测</div>
        </div>
        
        <!-- 机械通气风险预测 -->
        <div class="tab-content active" id="ventilation-tab">
            <div class="content">
                <div class="input-section">
                    <div class="form-group">
                        <label for="hospital_stay">住院天数 (Hospital_stay_days):</label>
                        <input type="number" id="hospital_stay" step="0.1" min="0" placeholder="请输入住院天数">
                    </div>
                    
                    <div class="form-group">
                        <label for="ph">pH值 (PH):</label>
                        <input type="number" id="ph" step="0.01" min="6.5" max="8.0" placeholder="6.5-8.0">
                    </div>
                    
                    <div class="form-group">
                        <label for="fibrinogen">纤维蛋白原 (Fibrinogen, g/L):</label>
                        <input type="number" id="fibrinogen" step="0.1" min="0" placeholder="请输入纤维蛋白原值">
                    </div>
                    
                    <div class="form-group">
                        <label for="urea">尿素 (Urea, mmol/L):</label>
                        <input type="number" id="urea" step="0.1" min="0" placeholder="请输入尿素值">
                    </div>
                    
                    <div class="form-group">
                        <label for="calcium">钙离子 (Calcium_total, mmol/L):</label>
                        <input type="number" id="calcium" step="0.01" min="0" placeholder="请输入钙离子值">
                    </div>
                    
                    <div class="form-group">
                        <label for="heart_rate">心率 (Heart_rate, 次/分):</label>
                        <input type="number" id="heart_rate" step="1" min="0" placeholder="请输入心率">
                    </div>
                    
                    <button onclick="calculateVentilationRisk()">计算机械通气风险</button>
                    <button class="example-btn" onclick="loadVentilationExampleData()">加载示例数据</button>
                </div>
                
                <div class="result-section">
                    <h2>机械通气风险预测结果</h2>
                    <div id="ventilation-result" class="result-box">
                        <p>请输入患者数据并点击计算按钮</p>
                    </div>
                </div>
            </div>
            
            <div class="model-info">
                

                






                <p style="margin-top: 15px; font-size: 14px;">注：本预测工具基于XGBoost机器学习模型，包含50棵决策树，最大深度4层。计算结果仅供参考，临床决策需结合患者全面情况。</p>
            </div>
        </div>
        
        <!-- 死亡风险预测 -->
        <div class="tab-content" id="mortality-tab">
            <div class="content">
                <div class="input-section">
                    <div class="form-group">
                        <label for="mortality_hospital_stay">住院天数 (Hospital_stay_days):</label>
                        <input type="number" id="mortality_hospital_stay" step="0.1" min="0" placeholder="请输入住院天数">
                    </div>
                    
                    <div class="form-group">
                        <label for="mechanical_ventilation">是否机械通气 (Mechanical_ventilation):</label>
                        <select id="mechanical_ventilation">
                            <option value="0">否</option>
                            <option value="1">是</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="lactate">乳酸值 (Lactate, mmol/L):</label>
                        <input type="number" id="lactate" step="0.1" min="0" placeholder="请输入乳酸值">
                    </div>
                    
                    <button onclick="calculateMortalityRisk()">计算死亡风险</button>
                    <button class="example-btn" onclick="loadMortalityExampleData()">加载示例数据</button>
                </div>
                
                <div class="result-section">
                    <h2>死亡风险预测结果</h2>
                    <div id="mortality-result" class="result-box">
                        <p>请输入患者数据并点击计算按钮</p>
                    </div>
                </div>
            </div>
            
            <div class="model-info">
                







                <p style="margin-top: 15px; font-size: 14px;">注：本预测工具基于XGBoost机器学习模型，包含150棵决策树，最大深度3层。计算结果仅供参考，临床决策需结合患者全面情况。</p>
            </div>
        </div>
    </div>

    <script>
        // 选项卡切换功能
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // 移除所有活动状态
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // 添加当前活动状态
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
            });
        });
        
        // 加载机械通气风险预测示例数据
        function loadVentilationExampleData() {
            document.getElementById('hospital_stay').value = 15.5;
            document.getElementById('ph').value = 7.25;
            document.getElementById('fibrinogen').value = 2.8;
            document.getElementById('urea').value = 18.7;
            document.getElementById('calcium').value = 1.95;
            document.getElementById('heart_rate').value = 125;
            
            // 显示提示信息
            const resultDiv = document.getElementById('ventilation-result');
            resultDiv.className = 'result-box';
            resultDiv.innerHTML = '<p>示例数据已加载，请点击"计算机械通气风险"按钮</p>';
        }
        
        // 加载死亡风险预测示例数据
        function loadMortalityExampleData() {
            document.getElementById('mortality_hospital_stay').value = 12.3;
            document.getElementById('mechanical_ventilation').value = 1;
            document.getElementById('lactate').value = 3.8;
            
            // 显示提示信息
            const resultDiv = document.getElementById('mortality-result');
            resultDiv.className = 'result-box';
            resultDiv.innerHTML = '<p>示例数据已加载，请点击"计算死亡风险"按钮</p>';
        }
        
        // 简化的XGBoost预测模型 - 机械通气风险
        function predictVentilationRisk(features) {
            const {
                hospital_stay,
                ph,
                fibrinogen,
                urea,
                calcium,
                heart_rate
            } = features;
            
            // 计算基础分数（基于特征重要性）
            let score = 0;
            
            // pH值的影响（最重要特征）
            if (ph < 7.2) score += 0.3;
            else if (ph < 7.35) score += 0.15;
            else if (ph > 7.45) score += 0.1;
            
            // 住院天数的影响
            if (hospital_stay > 20) score += 0.22;
            else if (hospital_stay > 10) score += 0.1;
            
            // 纤维蛋白原的影响
            if (fibrinogen < 2.5) score += 0.13;
            else if (fibrinogen < 3.5) score += 0.06;
            
            // 尿素的影响
            if (urea > 15) score += 0.12;
            else if (urea > 10) score += 0.06;
            
            // 钙离子的影响
            if (calcium < 2.0) score += 0.12;
            else if (calcium < 2.2) score += 0.06;
            
            // 心率的影响
            if (heart_rate > 120) score += 0.1;
            else if (heart_rate > 100) score += 0.05;
            
            // 使用sigmoid函数转换为概率
            return 1 / (1 + Math.exp(-score * 5 + 2.5));
        }
        
        // 简化的XGBoost预测模型 - 死亡风险
        function predictMortalityRisk(features) {
            const {
                hospital_stay,
                mechanical_ventilation,
                lactate
            } = features;
            
            // 计算基础分数（基于特征重要性）
            let score = 0;
            
            // 住院天数的影响（最重要特征）
            if (hospital_stay > 15) score += 0.683;
            else if (hospital_stay > 7) score += 0.4;
            else if (hospital_stay > 3) score += 0.2;
            
            // 机械通气的影响
            if (mechanical_ventilation == 1) score += 0.196;
            
            // 乳酸值的影响
            if (lactate > 4.0) score += 0.121;
            else if (lactate > 2.5) score += 0.06;
            
            // 使用sigmoid函数转换为概率
            return 1 / (1 + Math.exp(-score * 5 + 2.5));
        }
        
        // 计算机械通气风险
        function calculateVentilationRisk() {
            // 获取输入值
            const features = {
                hospital_stay: parseFloat(document.getElementById('hospital_stay').value) || 0,
                ph: parseFloat(document.getElementById('ph').value) || 0,
                fibrinogen: parseFloat(document.getElementById('fibrinogen').value) || 0,
                urea: parseFloat(document.getElementById('urea').value) || 0,
                calcium: parseFloat(document.getElementById('calcium').value) || 0,
                heart_rate: parseFloat(document.getElementById('heart_rate').value) || 0
            };
            
            // 验证输入
            if (features.ph < 6.5 || features.ph > 8.0 || isNaN(features.ph)) {
                alert("请输入有效的pH值（6.5-8.0）");
                return;
            }
            
            if (features.hospital_stay <= 0 || isNaN(features.hospital_stay)) {
                alert("请输入有效的住院天数");
                return;
            }
            
            // 显示加载中
            const resultDiv = document.getElementById('ventilation-result');
            resultDiv.innerHTML = '<p>计算中...</p>';
            
            // 使用setTimeout模拟计算过程
            setTimeout(() => {
                try {
                    // 使用模型预测
                    const probability = predictVentilationRisk(features);
                    
                    
                    // 显示结果
                    displayVentilationResult(probability, features);
                } catch (error) {
                    resultDiv.innerHTML = '<p>计算错误，请检查输入数据</p>';
                    console.error(error);
                }
            }, 1000);
        }
        
        // 计算机械通气风险结果显示
        function displayVentilationResult(probability, features) {
            const resultDiv = document.getElementById('ventilation-result');
            const percent = (probability * 100).toFixed(1);
            
            // 确定风险等级
            let riskLevel, riskClass, recommendation;
            
            if (probability < 0.3) {
                riskLevel = "低风险";
                riskClass = "risk-low";
                recommendation = "患者机械通气风险较低，建议继续观察病情变化，维持当前治疗方案。";
            } else if (probability < 0.6) {
                riskLevel = "中风险";
                riskClass = "risk-medium";
                recommendation = "患者存在机械通气风险，建议密切监测呼吸功能，准备相关应急预案。";
            } else {
                riskLevel = "高风险";
                riskClass = "risk-high";
                recommendation = "患者机械通气风险很高，建议立即评估呼吸功能，准备机械通气设备，加强监护。";
            }
            
            // 更新结果显示
            resultDiv.className = `result-box ${riskClass}`;
            resultDiv.innerHTML = `
                <div class="risk-level">${riskLevel}</div>
                <div class="probability">${percent}%</div>
                <div class="recommendation">${recommendation}</div>
            `;
        }
        
        // 计算死亡风险
        function calculateMortalityRisk() {
            // 获取输入值
            const features = {
                hospital_stay: parseFloat(document.getElementById('mortality_hospital_stay').value) || 0,
                mechanical_ventilation: parseInt(document.getElementById('mechanical_ventilation').value) || 0,
                lactate: parseFloat(document.getElementById('lactate').value) || 0
            };
            
            // 验证输入
            if (features.hospital_stay <= 0 || isNaN(features.hospital_stay)) {
                alert("请输入有效的住院天数");
                return;
            }
            
            if (features.lactate < 0 || isNaN(features.lactate)) {
                alert("请输入有效的乳酸值");
                return;
            }
            
            // 显示加载中
            const resultDiv = document.getElementById('mortality-result');
            resultDiv.innerHTML = '<p>计算中...</p>';
            
            // 使用setTimeout模拟计算过程
            setTimeout(() => {
                try {
                    // 使用模型预测
                    const probability = predictMortalityRisk(features);
                    
                    // 显示结果
                    displayMortalityResult(probability, features);
                } catch (error) {
                    resultDiv.innerHTML = '<p>计算错误，请检查输入数据</p>';
                    console.error(error);
                }
            }, 1000);
        }
        
        // 计算死亡风险结果显示
        function displayMortalityResult(probability, features) {
            const resultDiv = document.getElementById('mortality-result');
            const percent = (probability * 100).toFixed(1);
            
            // 确定风险等级
            let riskLevel, riskClass, recommendation;
            
            if (probability < 0.2) {
                riskLevel = "低风险";
                riskClass = "risk-low";
                recommendation = "患者死亡风险较低，预后良好，建议继续当前治疗方案。";
            } else if (probability < 0.5) {
                riskLevel = "中风险";
                riskClass = "risk-medium";
                recommendation = "患者存在死亡风险，建议加强监护，优化治疗方案，密切监测生命体征。";
            } else {
                riskLevel = "高风险";
                riskClass = "risk-high";
                recommendation = "患者死亡风险很高，建议立即采取积极干预措施，多学科会诊，与家属充分沟通病情。";
            }
            
            // 更新结果显示
            resultDiv.className = `result-box ${riskClass}`;
            resultDiv.innerHTML = `
                <div class="risk-level">${riskLevel}</div>
                <div class="probability">${percent}%</div>
                <div class="recommendation">${recommendation}</div>
            `;
        }
    </script>
</body>
</html>
